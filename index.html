<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>å®Œæ•´æ­¦å™¨é˜²å¾¡RPG</title>
	<style>
		body { 
			font-family: Arial; 
			margin: 0;
			padding: 10px;
			background: #f0f0f0;
		}
		.login-box {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 0 10px rgba(0,0,0,0.2);
			z-index: 999;
		}
		.hidden { display: none; }
		.status-box {
			background: white;
			padding: 15px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			margin-bottom: 10px;
		}
		.button-group {
			display: flex;
			gap: 10px;
			margin: 10px 0;
		}
		button {
			flex: 1;
			padding: 12px;
			border: none;
			border-radius: 8px;
			color: white;
			font-size: 16px;
		}
		.backpack {
			background: white;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}
		.equipment-item {
			padding: 10px;
			margin: 5px 0;
			border-radius: 5px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.green { background: #c8e6c9; }
		.blue { background: #bbdefb; }
		.red { background: #ffcdd2; }
		.yellow { background: #fff9c4; }
		.pink { background: #f8bbd0; }
		.equipped { border: 2px solid #4CAF50; }
		#bossBar {
			height: 20px;
			background: #eee;
			border-radius: 10px;
			overflow: hidden;
			margin: 10px 0;
		}
		#bossHealth {
			height: 100%;
			background: #ff4444;
			transition: width 0.3s;
		}
		.boss-info {
			text-align: center;
			margin: 10px 0;
			font-size: 24px;
		}
		.auto-fighting { background: #FF5722; }
		.equipment-tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 10px;
		}
		.tab-button {
			padding: 8px 15px;
			border-radius: 5px;
			background: #ddd;
			border: none;
		}
		.active-tab {
			background: #4CAF50;
			color: white;
		}
		
		/* æ–°å¢æ¦‚ç‡è¡¨æ ·å¼ */
.probability-table {
	background: #fff;
	border-radius: 8px;
	padding: 10px;
	margin-top: 10px;
	box-shadow: 0 2px 3px rgba(0,0,0,0.1);
}
.prob-row {
	display: flex;
	justify-content: space-between;
	padding: 6px 0;
	border-bottom: 1px solid #eee;
}
.prob-row.rare {
	color: #FF4081;
	font-weight: bold;
}
.prob-row span:first-child {
	color: #666;
}
.prob-row span:last-child {
	color: #2196F3;
}

	</style>
</head>
<body>
	<div id="loginBox" class="login-box">
		<h2>æ³¨å†Œ/ç™»å½•</h2>
		<input type="text" id="username" placeholder="è´¦å·">
		<input type="password" id="password" placeholder="å¯†ç ">
		<input type="text" id="playerName" placeholder="è§’è‰²å">
		<div class="button-group">
			<button onclick="register()" style="background:#4CAF50">æ³¨å†Œ</button>
			<button onclick="login()" style="background:#2196F3">ç™»å½•</button>
		</div>
	</div>

	<!-- æ¸¸æˆä¸»ç•Œé¢ -->
	<div id="gameUI" class="hidden">
		<!-- çŠ¶æ€æ˜¾ç¤º -->
		<div class="status-box">
			<div>ğŸ‘¤<span id="showName">æ— å</span></div>
			<div>â¤ï¸è¡€é‡: <span id="hp">100</span>/<span id="maxHp">100</span></div>
			<div>ğŸ’é’»çŸ³: <span id="diamond">0</span></div>
			<div>ğŸ‘‘ç­‰çº§: <span id="level">1</span></div>
			<div>ğŸ“ˆç»éªŒ: <span id="exp">0<span id="needExp">100</span></div>
			<div>ğŸ”°å…³å¡: <span id="stage">1-1</span></div>
			<div>ğŸ—¡ï¸æ­¦å™¨: <span id="currentWeapon">æ— </span></div>
			<div>ğŸ›¡ï¸é˜²å¾¡: <span id="currentDefense">æ— </span></div>
		</div>
		
		<!-- BOSSæˆ˜ç•Œé¢ -->
	<div class="status-box">
		<h3>BOSSæˆ˜</h3>
		<div class="boss-info">
			<div id="bossEmoji">ğŸ¤ª</div>
			<div>Lv.<span id="bossLevel">1</span> BOSS</div>
			<div id="bossHp">100/100</div>
			<div>ğŸ†å‡»è´¥å¥–åŠ±: <span id="bossReward">ç»éªŒ50 + ç –çŸ³10 </span></div>
		</div>
		<div id="bossBar">
			<div id="bossHealth" style="width: 100%"></div>
		</div>
		<div class="button-group">
			<button onclick="attackBoss()" style="background:#F44336">ğŸ—¡ï¸æ”»å‡»BOSS</button>
			<button id="autoBtn" onclick="toggleAutoFight()" style="background:#9C27B0">âš¡è‡ªåŠ¨æˆ˜æ–—</button>
		</div>
	</div>
		
		<!-- å•†åŸç•Œé¢ -->
	<div class="status-box">
		<div class="equipment-tabs">
			<button class="tab-button active-tab" onclick="showShopTab('weapon')">ğŸ—¡ï¸æ­¦å™¨å•†åŸ</button>
			<button class="tab-button" onclick="showShopTab('defense')">ğŸ›¡ï¸é˜²å¾¡å•†åŸ</button>
		</div>
		
		<!-- åœ¨æ­¦å™¨å•†åŸéƒ¨åˆ†æ–°å¢æ¦‚ç‡è¡¨ -->
<div id="weaponShop" class="shop-tab">
	<div class="button-group">
		<button onclick="drawWeapon(1)" style="background:#FF9800">å•æŠ½ (200ğŸ’)</button>
		<button onclick="drawWeapon(10)" style="background:#FF5722">åè¿ (1800ğŸ’)</button>
	</div>
	<!-- æ–°å¢æ¦‚ç‡è¡¨ -->
	<div class="probability-table">
		<div class="prob-row"><span>ğŸ—¡ï¸Lv.1</span><span>83.4%</span></div>
		<div class="prob-row"><span>âš”ï¸Lv.2</span><span>10%</span></div>
		<div class="prob-row"><span>ğŸLv.3</span><span>5%</span></div>
		<div class="prob-row"><span>ğŸŒ‚Lv.4</span><span>1%</span></div>
		<div class="prob-row"><span>ğŸ¡Lv.5</span><span>0.5%</span></div>
		<div class="prob-row rare"><span>ğŸ­Lv.10</span><span>0.1%</span></div>
	</div>
</div>

<!-- åœ¨é˜²å¾¡å•†åŸéƒ¨åˆ†æ–°å¢æ¦‚ç‡è¡¨ -->
<div id="defenseShop" class="shop-tab" style="display:none">
	<div class="button-group">
		<button onclick="drawDefense(1)" style="background:#FF9800">å•æŠ½ (150ğŸ’)</button>
		<button onclick="drawDefense(10)" style="background:#FF5722">åè¿ (1350ğŸ’)</button>
	</div>
	<!-- æ–°å¢æ¦‚ç‡è¡¨ -->
	<div class="probability-table">
		<div class="prob-row"><span>ğŸ›¡ï¸Lv.1</span><span>83.4%</span></div>
		<div class="prob-row"><span>ğŸ”°Lv.2</span><span>10%</span></div>
		<div class="prob-row"><span>ğŸª˜Lv.3</span><span>5%</span></div>
		<div class="prob-row"><span>â›±ï¸Lv.4</span><span>1%</span></div>
		<div class="prob-row"><span>âšœï¸Lv.5</span><span>0.5%</span></div>
		<div class="prob-row rare"><span>ğŸ”±Lv.10</span><span>0.1%</span></div>
	</div>
</div>

		
		
		<!-- èƒŒåŒ…ç•Œé¢ -->
		<div class="backpack">
			<div class="equipment-tabs">
				<button class="tab-button active-tab" onclick="showBackpackTab('weapon')">æ­¦å™¨èƒŒåŒ…</button>
				<button class="tab-button" onclick="showBackpackTab('defense')">é˜²å¾¡èƒŒåŒ…</button>
			</div>
			<button onclick="combineEquipment()" style="background:#009688;width:100%">âš™ï¸ä¸€é”®åˆæˆ</button>
			<div id="equipmentList" style="margin-top: 10px;"></div>
		</div>
	</div>
	

  <!-- æç¤ºå®¹å™¨ -->
  <div id="messageBox" style="position: fixed; top: 20px; right: 20px; 
         background: gold; padding: 10px; display: none;"></div>

<script>
function showShopTab(type) {
	document.querySelectorAll('.shop-tab').forEach(tab => tab.style.display = 'none');
	document.getElementById(type + 'Shop').style.display = 'block';
	document.querySelectorAll('.shop .tab-button').forEach(btn => 
		btn.classList.remove('active-tab'));
	event.target.classList.add('active-tab');
}

function showBackpackTab(type) {
	document.querySelectorAll('.backpack .tab-button').forEach(btn => 
		btn.classList.remove('active-tab'));
	event.target.classList.add('active-tab');
	updateDisplay();
}


// ä¿®æ”¹åçš„åˆæˆåŠŸèƒ½
function combineEquipment() {
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	if(activeTab.includes("æ­¦å™¨")) {
		combineWeapons();
	} else {
		combineDefenses();
	}
}

// æ–°å¢é˜²å¾¡è£…å¤‡åˆæˆé€»è¾‘
function combineDefenses() {
	const counts = {};
	gameData.defenses.forEach(d => counts[d.level] = (counts[d.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.defenses = gameData.defenses.filter(d => {
				if(d.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			const newLevel = parseInt(lvl)+1;
			gameData.defenses.push({
				level: newLevel,
				defense: 100 * Math.pow(2, newLevel-1),
				color: getColor(newLevel)
			});
		}
	});
	updateDisplay();
	saveGame();
}

let gameData = {
	username: '',
	playerName: '',
	hp: 100,		 // å½“å‰è¡€é‡
	maxHp: 100,	   // æœ€å¤§è¡€é‡ï¼ˆç”±é˜²å¾¡è£…å¤‡å†³å®šï¼‰
	diamond: 0,	   // é’»çŸ³æ•°é‡
	level: 1,		 // ç©å®¶ç­‰çº§
	exp: 0,		   // å½“å‰ç»éªŒ
	needExp: 100,	 // å‡çº§æ‰€éœ€ç»éªŒ
	currentStage: 1,  // å½“å‰å…³å¡
	bossCount: 0,	 // å½“å‰å…³å¡å‡»è´¥BOSSæ•°é‡
	weapons: [],	  // æ­¦å™¨åˆ—è¡¨
	defenses: [],	 // é˜²å¾¡è£…å¤‡åˆ—è¡¨
	currentWeapon: null,  // å½“å‰è£…å¤‡çš„æ­¦å™¨
	currentDefense: null  // å½“å‰è£…å¤‡çš„é˜²å…·
};

// ================= æˆ˜æ–—ç³»ç»Ÿå˜é‡ =================
let bossHealth = 0;			// BOSSå½“å‰è¡€é‡
let autoFightInterval = null;  // è‡ªåŠ¨æˆ˜æ–—è®¡æ—¶å™¨
const bossEmojis = ['ğŸ¤ªWerid Face','ğŸ‘¿Demon','ğŸ¤¡Joker','ğŸ‘»Gost','ğŸ‘¹Oni','ğŸ‘ºTengu','ğŸ¤–Robot','ğŸ’€Skull','â˜ ï¸King Skull','ğŸ‘½Alien ','ğŸƒPumpkin ','ğŸ¥·ğŸ»Ninja','ğŸ§Ÿâ€â™€ï¸Zombie','ğŸ‘ï¸Cyclops','ğŸ…Santa','ğŸ§â€â™‚ï¸Genie','ğŸ§œâ€â™€ï¸Mermaid','ğŸ‘¼Angel']; // BOSSè¡¨æƒ…é›†åˆ

// ================= ç”¨æˆ·ç³»ç»Ÿ =================
function register() {
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const playerName = document.getElementById('playerName').value;
	
	if(!username || !password || !playerName) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
	
	const users = JSON.parse(localStorage.getItem('users') || '{}');
	if(users[username]) return alert('è´¦å·å·²å­˜åœ¨');
	
	users[username] = { password, playerName };
	localStorage.setItem('users', JSON.stringify(users));
	
	// åˆå§‹åŒ–ç©å®¶æ•°æ®
	gameData.weapons = [createWeapon(1)];
	gameData.defenses = [createDefense(1)];
	gameData.currentWeapon = gameData.weapons[0];
	gameData.currentDefense = gameData.defenses[0];
	gameData.hp = gameData.maxHp = gameData.defenses[0].defense; // è¡€é‡ç”±é˜²å¾¡è£…å¤‡å†³å®š
	
	alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
}

function login() {
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const users = JSON.parse(localStorage.getItem('users') || '{}');
	
	if(!users[username] || users[username].password !== password) {
		return alert('è´¦å·æˆ–å¯†ç é”™è¯¯');
	}
	
	const savedData = localStorage.getItem(`gameData_${username}`);
	if(savedData) {
		const loadedData = JSON.parse(savedData);
		Object.assign(gameData, loadedData);
		gameData.playerName = users[username].playerName;
		gameData.username = username;
		updateMaxHp();
	} else {
		gameData.playerName = users[username].playerName;
		gameData.username = username;
		gameData.weapons = [createWeapon(1)];
		gameData.defenses = [createDefense(1)];
		gameData.currentWeapon = gameData.weapons[0];
		gameData.currentDefense = gameData.defenses[0];
		gameData.hp = gameData.maxHp = gameData.defenses[0].defense;
	}
	
	document.getElementById('loginBox').classList.add('hidden');
	document.getElementById('gameUI').classList.remove('hidden');
	initializeBoss();
	updateDisplay();
}

// ================= è£…å¤‡ç³»ç»Ÿ =================
// æ–°å¢ï¼šæ­¦å™¨æŠ½å¡
// ä¿®æ”¹åçš„æŠ½å¥–æ¦‚ç‡é€»è¾‘
function getRandomLevel() {
	const rand = Math.random() * 100;
	if (rand < 0.1) return 10;   // 0.1%
	if (rand < 0.6) return 5;	// 0.5%
	if (rand < 1.6) return 4;	// 1%
	if (rand < 6.6) return 3;	// 5%
	if (rand < 16.6) return 2;   // 10%
	return 1;					// å‰©ä½™83.4%
}

// ä¿®æ”¹åçš„æ­¦å™¨æŠ½å¡å‡½æ•°
function drawWeapon(times) {
	const cost = times === 10 ? 1800 : 200;
	if(gameData.diamond < cost) return alert('ğŸ’é’»çŸ³ä¸è¶³ï¼');
	
	gameData.diamond -= cost;
	for(let i=0; i<times; i++){
		const level = getRandomLevel();
		gameData.weapons.push(createWeapon(level));
	}
	saveGame();
	updateDisplay();
}

// ä¿®æ”¹åçš„é˜²å¾¡æŠ½å¡å‡½æ•°
function drawDefense(times) {
	const cost = times === 10 ? 1350 : 150;
	if(gameData.diamond < cost) return alert('ğŸ’é’»çŸ³ä¸è¶³ï¼');
	
	gameData.diamond -= cost;
	for(let i=0; i<times; i++){
		const level = getRandomLevel();
		gameData.defenses.push(createDefense(level));
	}
	saveGame();
	updateDisplay();
}

// è£…å¤‡ç©¿æˆ´åŠŸèƒ½
function equipItem(level, type) {
	const items = type === 'weapon' ? gameData.weapons : gameData.defenses;
	const item = items.find(i => i.level === level);
	
	if(!item) return;
	
	if(type === 'weapon') {
		gameData.currentWeapon = item;
	} else {
		gameData.currentDefense = item;
		updateMaxHp();
		gameData.hp = gameData.maxHp; // æ›´æ¢é˜²å¾¡è£…å¤‡æ—¶å›æ»¡è¡€
	}
	saveGame();
	updateDisplay();
}

// ================= æˆ˜æ–—ç³»ç»Ÿ =================
function initializeBoss() {
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	bossHealth = 100 * Math.pow(2, bossLevel-1);
}

function attackBoss() {
	if(!gameData.currentWeapon) return alert('è¯·å…ˆè£…å¤‡æ­¦å™¨ï¼');
	
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	const bossAttack = 5 * Math.pow(2, bossLevel-1);
	const playerAttack = gameData.currentWeapon.attack;

	// ç©å®¶æ”»å‡»
	let tempBossHp = bossHealth - playerAttack;
	let tempPlayerHp = gameData.hp;
	
	// BOSSåå‡»
	if(tempBossHp > 0) {
		tempPlayerHp = Math.max(tempPlayerHp - bossAttack, 0);
	}

	// æ›´æ–°çŠ¶æ€
	bossHealth = Math.max(tempBossHp, 0);
	gameData.hp = tempPlayerHp;

	// å¤„ç†BOSSæ­»äº¡
	if(bossHealth <= 0) {
		const rewardBase = 50 * Math.pow(2, bossLevel-1);
		gameData.exp += rewardBase;
		gameData.diamond += bossLevel*10
		gameData.bossCount++;
		
		if(gameData.bossCount >= 10) {
			gameData.currentStage++;
			gameData.bossCount = 0;
		}
		initializeBoss();
	}

	checkLevelUp();
	checkPlayerSurvival();
	saveGame();
	updateDisplay();
}

// ================= åˆæˆç³»ç»Ÿ =================
function combineEquipment() {
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	if(activeTab === 'æ­¦å™¨èƒŒåŒ…') {
		combineWeapons();
	} else {
		combineDefenses();
	}
}

function combineWeapons() {
	const counts = {};
	gameData.weapons.forEach(w => counts[w.level] = (counts[w.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.weapons = gameData.weapons.filter(w => {
				if(w.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			gameData.weapons.push(createWeapon(parseInt(lvl)+1));
		}
	});
	updateDisplay();
	saveGame();
}

function combineDefenses() {
	const counts = {};
	gameData.defenses.forEach(d => counts[d.level] = (counts[d.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.defenses = gameData.defenses.filter(d => {
				if(d.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			gameData.defenses.push(createDefense(parseInt(lvl)+1));
		}
	});
	updateDisplay();
	saveGame();
}

// ================= è¾…åŠ©å‡½æ•° =================
function createWeapon(level) {
	return {
		level: level,
		attack: 5 * Math.pow(2, level-1),
		color: getColor(level)
	};
}

function createDefense(level) {
	return {
		level: level,
		defense: 100 * Math.pow(2, level-1), // é˜²å¾¡å€¼å³æœ€å¤§è¡€é‡
		color: getColor(level)
	};
}

function getColor(level) {
	const colors = ['green', 'blue', 'red', 'yellow', 'pink'];
	return colors[Math.min(Math.floor(level/5), 4)];
}

function updateMaxHp() {
	gameData.maxHp = gameData.currentDefense ? 
		gameData.currentDefense.defense : 0;
	gameData.hp = Math.min(gameData.hp, gameData.maxHp);
}

// ================= æ˜¾ç¤ºç³»ç»Ÿ =================
function updateDisplay() {
	// ç©å®¶çŠ¶æ€
	document.getElementById('showName').textContent = gameData.playerName;
	document.getElementById('hp').textContent = gameData.hp;
	document.getElementById('maxHp').textContent = gameData.maxHp;
	document.getElementById('diamond').textContent = gameData.diamond;
	document.getElementById('level').textContent = gameData.level;
	document.getElementById('exp').textContent = `${gameData.exp}/${gameData.needExp}`;
	document.getElementById('stage').textContent = `${gameData.currentStage}-${gameData.bossCount+1}`;
	document.getElementById('currentWeapon').textContent = 
		gameData.currentWeapon ? `Lv.${gameData.currentWeapon.level} (${gameData.currentWeapon.attack}æ”»)` : 'æ— ';
	document.getElementById('currentDefense').textContent = 
		gameData.currentDefense ? `Lv.${gameData.currentDefense.level} (${gameData.currentDefense.defense}è¡€)` : 'æ— ';

	// BOSSçŠ¶æ€
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	const maxBossHp = 100 * Math.pow(2, bossLevel-1);
	document.getElementById('bossEmoji').textContent = 
		bossEmojis[Math.min(bossLevel-1, bossEmojis.length-1)] || 'ğŸ‘¾';
	document.getElementById('bossLevel').textContent = bossLevel;
	document.getElementById('bossHp').textContent = 
		`â¤ï¸${Math.max(bossHealth,0)}/${maxBossHp}`;
	document.getElementById('bossReward').textContent = 
		`ğŸ“ˆç»éªŒ${50 * Math.pow(2, bossLevel-1)} + ğŸ’é’»çŸ³${10 * bossLevel}`;
	document.getElementById('bossHealth').style.width = 
		`${(Math.max(bossHealth,0)/maxBossHp*100)}%`;

	// è£…å¤‡åˆ—è¡¨
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	const type = activeTab.includes("æ­¦å™¨") ? 'weapon' : 'defense';
	const items = type === 'weapon' ? gameData.weapons : gameData.defenses;
	
	const container = document.getElementById('equipmentList');
	container.innerHTML = '';
	
	const counts = items.reduce((acc, item) => {
		acc[item.level] = (acc[item.level] || 0) + 1;
		return acc;
	}, {});

	Object.keys(counts).sort((a,b) => a - b).forEach(level => {
		const item = items.find(i => i.level == level);
		const div = document.createElement('div');
		div.className = `equipment-item ${item.color} ${
			(type === 'weapon' && gameData.currentWeapon?.level == level) ||
			(type === 'defense' && gameData.currentDefense?.level == level) ? 'equipped' : ''
		}`;

		div.innerHTML = `
			<div style="flex-grow:1">
				<div>Lv.${level} ${type === 'weapon' ? 'æ­¦å™¨' : 'é˜²å¾¡'}</div>
				<div style="font-size:12px;color:#666">
					${type === 'weapon' ? 
						`æ”»å‡»åŠ›: ${5 * Math.pow(2, level-1)}` : 
						`æœ€å¤§è¡€é‡: ${100 * Math.pow(2, level-1)}`}
				</div>
			</div>
			<div style="display:flex;align-items:center;gap:10px">
				<span style="font-weight:bold">Ã—${counts[level]}</span>
				<button onclick="equipItem(${level}, '${type}')" 
					style="background:#2196F3; padding:6px 12px; border-radius:4px; border:none; color:white">
					è£…å¤‡
				</button>
			</div>
		`;
		container.appendChild(div);
	});

	// è‡ªåŠ¨æˆ˜æ–—æŒ‰é’®çŠ¶æ€
	const autoBtn = document.getElementById('autoBtn');
	if(autoFightInterval) {
		autoBtn.textContent = 'ğŸ›‘åœæ­¢è‡ªåŠ¨';
		autoBtn.classList.add('auto-fighting');
	} else {
		autoBtn.textContent = 'âš¡è‡ªåŠ¨æˆ˜æ–—';
		autoBtn.classList.remove('auto-fighting');
	}
}

// ================= å…¶ä»–ç³»ç»Ÿ =================

function showMessage(text) {
      const box = document.getElementById("messageBox");
      box.textContent = text;
      box.style.display = "block";
      setTimeout(() => box.style.display = "none", 2000);
    }

function checkLevelUp() {
    while (gameData.exp >= gameData.needExp) {
        const overflowExp = gameData.exp - gameData.needExp;
        const currentLevel = gameData.level; // è®°å½•å‡çº§å‰ç­‰çº§
        
        gameData.level++; // ç­‰çº§æå‡
        gameData.exp = overflowExp; // ä¿ç•™æº¢å‡ºç»éªŒ
        
        // é’»çŸ³å¥–åŠ± = 100 * 2^(æ–°ç­‰çº§-2)ï¼ˆæŒ‡æ•°çº§å¢é•¿ï¼‰
        const diamondReward = 100 * Math.pow(2, currentLevel - 1);
        gameData.diamond += diamondReward;
        
        showMessage(`å‡çº§åˆ° ${gameData.level} çº§ï¼è·å¾— ${diamondReward}ğŸ’`);
        
        // è®¾ç½®ä¸‹ä¸€çº§æ‰€éœ€ç»éªŒï¼ˆç¿»å€ï¼‰
        gameData.needExp *= 2; 
        
        // æ¯æ¬¡å‡çº§å›æ»¡è¡€
        gameData.hp = gameData.maxHp;
    }
}

function checkPlayerSurvival() {
	if (gameData.hp <= 0) {
		// é‡ç½®åˆ°å…³å¡1-BOSS1
		gameData.currentStage = 1;	// å¼ºåˆ¶å›åˆ°ç¬¬1å…³
		gameData.bossCount = 0;	   // é‡ç½®BOSSè¿›åº¦
		// ä¿ç•™é’»çŸ³ã€ç­‰çº§å’Œç»éªŒ
		gameData.hp = gameData.maxHp; // å›æ»¡é˜²å¾¡è£…å¤‡æä¾›çš„è¡€é‡
		initializeBoss();			 // é‡æ–°åˆå§‹åŒ–BOSS
		alert('æˆ˜è´¥ï¼å…³å¡å°†é‡ç½®åˆ°1-1é‡æ–°å¼€å§‹ï¼');
		updateDisplay();
		saveGame();
	}
}

function toggleAutoFight() {
	const btn = document.getElementById('autoBtn');
	if (autoFightInterval) {
		clearInterval(autoFightInterval);
		autoFightInterval = null;
	} else {
		autoFightInterval = setInterval(() => {
			if (bossHealth > 0 && gameData.hp > 0) {
				attackBoss();
			} else {
				clearInterval(autoFightInterval);
				autoFightInterval = null;
			}
		}, 1000);
	}
	updateDisplay();
}

function saveGame() {
	const saveData = {
		username: gameData.username,
		playerName: gameData.playerName,
		hp: gameData.hp,
		maxHp: gameData.maxHp,
		diamond: gameData.diamond,
		level: gameData.level,
		exp: gameData.exp,
		needExp: gameData.needExp,
		currentStage: gameData.currentStage,
		bossCount: gameData.bossCount,
		weapons: gameData.weapons,
		defenses: gameData.defenses,
		currentWeapon: gameData.currentWeapon,
		currentDefense: gameData.currentDefense
	};
	localStorage.setItem(`gameData_${gameData.username}`, JSON.stringify(saveData));
}

// ================= åˆå§‹åŒ–æ¸¸æˆ =================
function initializeGame() {
	const savedUsers = localStorage.getItem('users');
	if(!savedUsers) {
		document.getElementById('loginBox').classList.remove('hidden');
	} else {
		document.getElementById('gameUI').classList.remove('hidden');
		initializeBoss();
		updateDisplay();
	}
}

// å¯åŠ¨æ¸¸æˆ
initializeGame();
</script>
</body>
</html>
