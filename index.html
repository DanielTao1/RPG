<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>完整武器防御RPG</title>
	<style>
		body { 
			font-family: Arial; 
			margin: 0;
			padding: 10px;
			background: #f0f0f0;
		}
		.login-box {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 0 10px rgba(0,0,0,0.2);
			z-index: 999;
		}
		.hidden { display: none; }
		.status-box {
			background: white;
			padding: 15px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			margin-bottom: 10px;
		}
		.button-group {
			display: flex;
			gap: 10px;
			margin: 10px 0;
		}
		button {
			flex: 1;
			padding: 12px;
			border: none;
			border-radius: 8px;
			color: white;
			font-size: 16px;
		}
		.backpack {
			background: white;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}
		.equipment-item {
			padding: 10px;
			margin: 5px 0;
			border-radius: 5px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.green { background: #c8e6c9; }
		.blue { background: #bbdefb; }
		.red { background: #ffcdd2; }
		.yellow { background: #fff9c4; }
		.pink { background: #f8bbd0; }
		.equipped { border: 2px solid #4CAF50; }
		#bossBar {
			height: 20px;
			background: #eee;
			border-radius: 10px;
			overflow: hidden;
			margin: 10px 0;
		}
		#bossHealth {
			height: 100%;
			background: #ff4444;
			transition: width 0.3s;
		}
		.boss-info {
			text-align: center;
			margin: 10px 0;
			font-size: 24px;
		}
		.auto-fighting { background: #FF5722; }
		.equipment-tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 10px;
		}
		.tab-button {
			padding: 8px 15px;
			border-radius: 5px;
			background: #ddd;
			border: none;
		}
		.active-tab {
			background: #4CAF50;
			color: white;
		}
		
		/* 新增概率表样式 */
.probability-table {
	background: #fff;
	border-radius: 8px;
	padding: 10px;
	margin-top: 10px;
	box-shadow: 0 2px 3px rgba(0,0,0,0.1);
}
.prob-row {
	display: flex;
	justify-content: space-between;
	padding: 6px 0;
	border-bottom: 1px solid #eee;
}
.prob-row.rare {
	color: #FF4081;
	font-weight: bold;
}
.prob-row span:first-child {
	color: #666;
}
.prob-row span:last-child {
	color: #2196F3;
}

	</style>
</head>
<body>
	<div id="loginBox" class="login-box">
		<h2>注册/登录</h2>
		<input type="text" id="username" placeholder="账号">
		<input type="password" id="password" placeholder="密码">
		<input type="text" id="playerName" placeholder="角色名">
		<div class="button-group">
			<button onclick="register()" style="background:#4CAF50">注册</button>
			<button onclick="login()" style="background:#2196F3">登录</button>
		</div>
	</div>

	<!-- 游戏主界面 -->
	<div id="gameUI" class="hidden">
		<!-- 状态显示 -->
		<div class="status-box">
			<div>👤<span id="showName">无名</span></div>
			<div>❤️血量: <span id="hp">100</span>/<span id="maxHp">100</span></div>
			<div>💎钻石: <span id="diamond">0</span></div>
			<div>👑等级: <span id="level">1</span></div>
			<div>📈经验: <span id="exp">0<span id="needExp">100</span></div>
			<div>🔰关卡: <span id="stage">1-1</span></div>
			<div>🗡️武器: <span id="currentWeapon">无</span></div>
			<div>🛡️防御: <span id="currentDefense">无</span></div>
		</div>
		
		<!-- BOSS战界面 -->
	<div class="status-box">
		<h3>BOSS战</h3>
		<div class="boss-info">
			<div id="bossEmoji">🤪</div>
			<div>Lv.<span id="bossLevel">1</span> BOSS</div>
			<div id="bossHp">100/100</div>
			<div>🏆击败奖励: <span id="bossReward">经验50 + 砖石10 </span></div>
		</div>
		<div id="bossBar">
			<div id="bossHealth" style="width: 100%"></div>
		</div>
		<div class="button-group">
			<button onclick="attackBoss()" style="background:#F44336">🗡️攻击BOSS</button>
			<button id="autoBtn" onclick="toggleAutoFight()" style="background:#9C27B0">⚡自动战斗</button>
		</div>
	</div>
		
		<!-- 商城界面 -->
	<div class="status-box">
		<div class="equipment-tabs">
			<button class="tab-button active-tab" onclick="showShopTab('weapon')">🗡️武器商城</button>
			<button class="tab-button" onclick="showShopTab('defense')">🛡️防御商城</button>
		</div>
		
		<!-- 在武器商城部分新增概率表 -->
<div id="weaponShop" class="shop-tab">
	<div class="button-group">
		<button onclick="drawWeapon(1)" style="background:#FF9800">单抽 (200💎)</button>
		<button onclick="drawWeapon(10)" style="background:#FF5722">十连 (1800💎)</button>
	</div>
	<!-- 新增概率表 -->
	<div class="probability-table">
		<div class="prob-row"><span>🗡️Lv.1</span><span>83.4%</span></div>
		<div class="prob-row"><span>⚔️Lv.2</span><span>10%</span></div>
		<div class="prob-row"><span>🏏Lv.3</span><span>5%</span></div>
		<div class="prob-row"><span>🌂Lv.4</span><span>1%</span></div>
		<div class="prob-row"><span>🍡Lv.5</span><span>0.5%</span></div>
		<div class="prob-row rare"><span>🍭Lv.10</span><span>0.1%</span></div>
	</div>
</div>

<!-- 在防御商城部分新增概率表 -->
<div id="defenseShop" class="shop-tab" style="display:none">
	<div class="button-group">
		<button onclick="drawDefense(1)" style="background:#FF9800">单抽 (150💎)</button>
		<button onclick="drawDefense(10)" style="background:#FF5722">十连 (1350💎)</button>
	</div>
	<!-- 新增概率表 -->
	<div class="probability-table">
		<div class="prob-row"><span>🛡️Lv.1</span><span>83.4%</span></div>
		<div class="prob-row"><span>🔰Lv.2</span><span>10%</span></div>
		<div class="prob-row"><span>🪘Lv.3</span><span>5%</span></div>
		<div class="prob-row"><span>⛱️Lv.4</span><span>1%</span></div>
		<div class="prob-row"><span>⚜️Lv.5</span><span>0.5%</span></div>
		<div class="prob-row rare"><span>🔱Lv.10</span><span>0.1%</span></div>
	</div>
</div>

		
		
		<!-- 背包界面 -->
		<div class="backpack">
			<div class="equipment-tabs">
				<button class="tab-button active-tab" onclick="showBackpackTab('weapon')">武器背包</button>
				<button class="tab-button" onclick="showBackpackTab('defense')">防御背包</button>
			</div>
			<button onclick="combineEquipment()" style="background:#009688;width:100%">⚙️一键合成</button>
			<div id="equipmentList" style="margin-top: 10px;"></div>
		</div>
	</div>
	

  <!-- 提示容器 -->
  <div id="messageBox" style="position: fixed; top: 20px; right: 20px; 
         background: gold; padding: 10px; display: none;"></div>

<script>
function showShopTab(type) {
	document.querySelectorAll('.shop-tab').forEach(tab => tab.style.display = 'none');
	document.getElementById(type + 'Shop').style.display = 'block';
	document.querySelectorAll('.shop .tab-button').forEach(btn => 
		btn.classList.remove('active-tab'));
	event.target.classList.add('active-tab');
}

function showBackpackTab(type) {
	document.querySelectorAll('.backpack .tab-button').forEach(btn => 
		btn.classList.remove('active-tab'));
	event.target.classList.add('active-tab');
	updateDisplay();
}


// 修改后的合成功能
function combineEquipment() {
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	if(activeTab.includes("武器")) {
		combineWeapons();
	} else {
		combineDefenses();
	}
}

// 新增防御装备合成逻辑
function combineDefenses() {
	const counts = {};
	gameData.defenses.forEach(d => counts[d.level] = (counts[d.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.defenses = gameData.defenses.filter(d => {
				if(d.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			const newLevel = parseInt(lvl)+1;
			gameData.defenses.push({
				level: newLevel,
				defense: 100 * Math.pow(2, newLevel-1),
				color: getColor(newLevel)
			});
		}
	});
	updateDisplay();
	saveGame();
}

let gameData = {
	username: '',
	playerName: '',
	hp: 100,		 // 当前血量
	maxHp: 100,	   // 最大血量（由防御装备决定）
	diamond: 0,	   // 钻石数量
	level: 1,		 // 玩家等级
	exp: 0,		   // 当前经验
	needExp: 100,	 // 升级所需经验
	currentStage: 1,  // 当前关卡
	bossCount: 0,	 // 当前关卡击败BOSS数量
	weapons: [],	  // 武器列表
	defenses: [],	 // 防御装备列表
	currentWeapon: null,  // 当前装备的武器
	currentDefense: null  // 当前装备的防具
};

// ================= 战斗系统变量 =================
let bossHealth = 0;			// BOSS当前血量
let autoFightInterval = null;  // 自动战斗计时器
const bossEmojis = ['🤪Werid Face','👿Demon','🤡Joker','👻Gost','👹Oni','👺Tengu','🤖Robot','💀Skull','☠️King Skull','👽Alien ','🎃Pumpkin ','🥷🏻Ninja','🧟‍♀️Zombie','👁️Cyclops','🎅Santa','🧞‍♂️Genie','🧜‍♀️Mermaid','👼Angel']; // BOSS表情集合

// ================= 用户系统 =================
function register() {
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const playerName = document.getElementById('playerName').value;
	
	if(!username || !password || !playerName) return alert('请填写完整信息');
	
	const users = JSON.parse(localStorage.getItem('users') || '{}');
	if(users[username]) return alert('账号已存在');
	
	users[username] = { password, playerName };
	localStorage.setItem('users', JSON.stringify(users));
	
	// 初始化玩家数据
	gameData.weapons = [createWeapon(1)];
	gameData.defenses = [createDefense(1)];
	gameData.currentWeapon = gameData.weapons[0];
	gameData.currentDefense = gameData.defenses[0];
	gameData.hp = gameData.maxHp = gameData.defenses[0].defense; // 血量由防御装备决定
	
	alert('注册成功，请登录');
}

function login() {
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const users = JSON.parse(localStorage.getItem('users') || '{}');
	
	if(!users[username] || users[username].password !== password) {
		return alert('账号或密码错误');
	}
	
	const savedData = localStorage.getItem(`gameData_${username}`);
	if(savedData) {
		const loadedData = JSON.parse(savedData);
		Object.assign(gameData, loadedData);
		gameData.playerName = users[username].playerName;
		gameData.username = username;
		updateMaxHp();
	} else {
		gameData.playerName = users[username].playerName;
		gameData.username = username;
		gameData.weapons = [createWeapon(1)];
		gameData.defenses = [createDefense(1)];
		gameData.currentWeapon = gameData.weapons[0];
		gameData.currentDefense = gameData.defenses[0];
		gameData.hp = gameData.maxHp = gameData.defenses[0].defense;
	}
	
	document.getElementById('loginBox').classList.add('hidden');
	document.getElementById('gameUI').classList.remove('hidden');
	initializeBoss();
	updateDisplay();
}

// ================= 装备系统 =================
// 新增：武器抽卡
// 修改后的抽奖概率逻辑
function getRandomLevel() {
	const rand = Math.random() * 100;
	if (rand < 0.1) return 10;   // 0.1%
	if (rand < 0.6) return 5;	// 0.5%
	if (rand < 1.6) return 4;	// 1%
	if (rand < 6.6) return 3;	// 5%
	if (rand < 16.6) return 2;   // 10%
	return 1;					// 剩余83.4%
}

// 修改后的武器抽卡函数
function drawWeapon(times) {
	const cost = times === 10 ? 1800 : 200;
	if(gameData.diamond < cost) return alert('💎钻石不足！');
	
	gameData.diamond -= cost;
	for(let i=0; i<times; i++){
		const level = getRandomLevel();
		gameData.weapons.push(createWeapon(level));
	}
	saveGame();
	updateDisplay();
}

// 修改后的防御抽卡函数
function drawDefense(times) {
	const cost = times === 10 ? 1350 : 150;
	if(gameData.diamond < cost) return alert('💎钻石不足！');
	
	gameData.diamond -= cost;
	for(let i=0; i<times; i++){
		const level = getRandomLevel();
		gameData.defenses.push(createDefense(level));
	}
	saveGame();
	updateDisplay();
}

// 装备穿戴功能
function equipItem(level, type) {
	const items = type === 'weapon' ? gameData.weapons : gameData.defenses;
	const item = items.find(i => i.level === level);
	
	if(!item) return;
	
	if(type === 'weapon') {
		gameData.currentWeapon = item;
	} else {
		gameData.currentDefense = item;
		updateMaxHp();
		gameData.hp = gameData.maxHp; // 更换防御装备时回满血
	}
	saveGame();
	updateDisplay();
}

// ================= 战斗系统 =================
function initializeBoss() {
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	bossHealth = 100 * Math.pow(2, bossLevel-1);
}

function attackBoss() {
	if(!gameData.currentWeapon) return alert('请先装备武器！');
	
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	const bossAttack = 5 * Math.pow(2, bossLevel-1);
	const playerAttack = gameData.currentWeapon.attack;

	// 玩家攻击
	let tempBossHp = bossHealth - playerAttack;
	let tempPlayerHp = gameData.hp;
	
	// BOSS反击
	if(tempBossHp > 0) {
		tempPlayerHp = Math.max(tempPlayerHp - bossAttack, 0);
	}

	// 更新状态
	bossHealth = Math.max(tempBossHp, 0);
	gameData.hp = tempPlayerHp;

	// 处理BOSS死亡
	if(bossHealth <= 0) {
		const rewardBase = 50 * Math.pow(2, bossLevel-1);
		gameData.exp += rewardBase;
		gameData.diamond += bossLevel*10
		gameData.bossCount++;
		
		if(gameData.bossCount >= 10) {
			gameData.currentStage++;
			gameData.bossCount = 0;
		}
		initializeBoss();
	}

	checkLevelUp();
	checkPlayerSurvival();
	saveGame();
	updateDisplay();
}

// ================= 合成系统 =================
function combineEquipment() {
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	if(activeTab === '武器背包') {
		combineWeapons();
	} else {
		combineDefenses();
	}
}

function combineWeapons() {
	const counts = {};
	gameData.weapons.forEach(w => counts[w.level] = (counts[w.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.weapons = gameData.weapons.filter(w => {
				if(w.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			gameData.weapons.push(createWeapon(parseInt(lvl)+1));
		}
	});
	updateDisplay();
	saveGame();
}

function combineDefenses() {
	const counts = {};
	gameData.defenses.forEach(d => counts[d.level] = (counts[d.level] || 0) + 1);
	
	Object.keys(counts).sort((a,b) => a - b).forEach(lvl => {
		let count = Math.floor(counts[lvl] / 3);
		while(count-- > 0) {
			let removed = 0;
			gameData.defenses = gameData.defenses.filter(d => {
				if(d.level == lvl && removed < 3) {
					removed++;
					return false;
				}
				return true;
			});
			gameData.defenses.push(createDefense(parseInt(lvl)+1));
		}
	});
	updateDisplay();
	saveGame();
}

// ================= 辅助函数 =================
function createWeapon(level) {
	return {
		level: level,
		attack: 5 * Math.pow(2, level-1),
		color: getColor(level)
	};
}

function createDefense(level) {
	return {
		level: level,
		defense: 100 * Math.pow(2, level-1), // 防御值即最大血量
		color: getColor(level)
	};
}

function getColor(level) {
	const colors = ['green', 'blue', 'red', 'yellow', 'pink'];
	return colors[Math.min(Math.floor(level/5), 4)];
}

function updateMaxHp() {
	gameData.maxHp = gameData.currentDefense ? 
		gameData.currentDefense.defense : 0;
	gameData.hp = Math.min(gameData.hp, gameData.maxHp);
}

// ================= 显示系统 =================
function updateDisplay() {
	// 玩家状态
	document.getElementById('showName').textContent = gameData.playerName;
	document.getElementById('hp').textContent = gameData.hp;
	document.getElementById('maxHp').textContent = gameData.maxHp;
	document.getElementById('diamond').textContent = gameData.diamond;
	document.getElementById('level').textContent = gameData.level;
	document.getElementById('exp').textContent = `${gameData.exp}/${gameData.needExp}`;
	document.getElementById('stage').textContent = `${gameData.currentStage}-${gameData.bossCount+1}`;
	document.getElementById('currentWeapon').textContent = 
		gameData.currentWeapon ? `Lv.${gameData.currentWeapon.level} (${gameData.currentWeapon.attack}攻)` : '无';
	document.getElementById('currentDefense').textContent = 
		gameData.currentDefense ? `Lv.${gameData.currentDefense.level} (${gameData.currentDefense.defense}血)` : '无';

	// BOSS状态
	const bossLevel = Math.ceil(gameData.currentStage / 10);
	const maxBossHp = 100 * Math.pow(2, bossLevel-1);
	document.getElementById('bossEmoji').textContent = 
		bossEmojis[Math.min(bossLevel-1, bossEmojis.length-1)] || '👾';
	document.getElementById('bossLevel').textContent = bossLevel;
	document.getElementById('bossHp').textContent = 
		`❤️${Math.max(bossHealth,0)}/${maxBossHp}`;
	document.getElementById('bossReward').textContent = 
		`📈经验${50 * Math.pow(2, bossLevel-1)} + 💎钻石${10 * bossLevel}`;
	document.getElementById('bossHealth').style.width = 
		`${(Math.max(bossHealth,0)/maxBossHp*100)}%`;

	// 装备列表
	const activeTab = document.querySelector('.backpack .active-tab').textContent;
	const type = activeTab.includes("武器") ? 'weapon' : 'defense';
	const items = type === 'weapon' ? gameData.weapons : gameData.defenses;
	
	const container = document.getElementById('equipmentList');
	container.innerHTML = '';
	
	const counts = items.reduce((acc, item) => {
		acc[item.level] = (acc[item.level] || 0) + 1;
		return acc;
	}, {});

	Object.keys(counts).sort((a,b) => a - b).forEach(level => {
		const item = items.find(i => i.level == level);
		const div = document.createElement('div');
		div.className = `equipment-item ${item.color} ${
			(type === 'weapon' && gameData.currentWeapon?.level == level) ||
			(type === 'defense' && gameData.currentDefense?.level == level) ? 'equipped' : ''
		}`;

		div.innerHTML = `
			<div style="flex-grow:1">
				<div>Lv.${level} ${type === 'weapon' ? '武器' : '防御'}</div>
				<div style="font-size:12px;color:#666">
					${type === 'weapon' ? 
						`攻击力: ${5 * Math.pow(2, level-1)}` : 
						`最大血量: ${100 * Math.pow(2, level-1)}`}
				</div>
			</div>
			<div style="display:flex;align-items:center;gap:10px">
				<span style="font-weight:bold">×${counts[level]}</span>
				<button onclick="equipItem(${level}, '${type}')" 
					style="background:#2196F3; padding:6px 12px; border-radius:4px; border:none; color:white">
					装备
				</button>
			</div>
		`;
		container.appendChild(div);
	});

	// 自动战斗按钮状态
	const autoBtn = document.getElementById('autoBtn');
	if(autoFightInterval) {
		autoBtn.textContent = '🛑停止自动';
		autoBtn.classList.add('auto-fighting');
	} else {
		autoBtn.textContent = '⚡自动战斗';
		autoBtn.classList.remove('auto-fighting');
	}
}

// ================= 其他系统 =================

function showMessage(text) {
      const box = document.getElementById("messageBox");
      box.textContent = text;
      box.style.display = "block";
      setTimeout(() => box.style.display = "none", 2000);
    }

function checkLevelUp() {
    while (gameData.exp >= gameData.needExp) {
        const overflowExp = gameData.exp - gameData.needExp;
        const currentLevel = gameData.level; // 记录升级前等级
        
        gameData.level++; // 等级提升
        gameData.exp = overflowExp; // 保留溢出经验
        
        // 钻石奖励 = 100 * 2^(新等级-2)（指数级增长）
        const diamondReward = 100 * Math.pow(2, currentLevel - 1);
        gameData.diamond += diamondReward;
        
        showMessage(`升级到 ${gameData.level} 级！获得 ${diamondReward}💎`);
        
        // 设置下一级所需经验（翻倍）
        gameData.needExp *= 2; 
        
        // 每次升级回满血
        gameData.hp = gameData.maxHp;
    }
}

function checkPlayerSurvival() {
	if (gameData.hp <= 0) {
		// 重置到关卡1-BOSS1
		gameData.currentStage = 1;	// 强制回到第1关
		gameData.bossCount = 0;	   // 重置BOSS进度
		// 保留钻石、等级和经验
		gameData.hp = gameData.maxHp; // 回满防御装备提供的血量
		initializeBoss();			 // 重新初始化BOSS
		alert('战败！关卡将重置到1-1重新开始！');
		updateDisplay();
		saveGame();
	}
}

function toggleAutoFight() {
	const btn = document.getElementById('autoBtn');
	if (autoFightInterval) {
		clearInterval(autoFightInterval);
		autoFightInterval = null;
	} else {
		autoFightInterval = setInterval(() => {
			if (bossHealth > 0 && gameData.hp > 0) {
				attackBoss();
			} else {
				clearInterval(autoFightInterval);
				autoFightInterval = null;
			}
		}, 1000);
	}
	updateDisplay();
}

function saveGame() {
	const saveData = {
		username: gameData.username,
		playerName: gameData.playerName,
		hp: gameData.hp,
		maxHp: gameData.maxHp,
		diamond: gameData.diamond,
		level: gameData.level,
		exp: gameData.exp,
		needExp: gameData.needExp,
		currentStage: gameData.currentStage,
		bossCount: gameData.bossCount,
		weapons: gameData.weapons,
		defenses: gameData.defenses,
		currentWeapon: gameData.currentWeapon,
		currentDefense: gameData.currentDefense
	};
	localStorage.setItem(`gameData_${gameData.username}`, JSON.stringify(saveData));
}

// ================= 初始化游戏 =================
function initializeGame() {
	const savedUsers = localStorage.getItem('users');
	if(!savedUsers) {
		document.getElementById('loginBox').classList.remove('hidden');
	} else {
		document.getElementById('gameUI').classList.remove('hidden');
		initializeBoss();
		updateDisplay();
	}
}

// 启动游戏
initializeGame();
</script>
</body>
</html>
